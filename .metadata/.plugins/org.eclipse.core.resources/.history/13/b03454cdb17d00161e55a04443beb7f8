import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.swing.JOptionPane;


public class ConflictCheck {
	private static Connection connect;
	
	private static ResultSet FindCourses(int day,int slot){
		try{
			String query = "Select * from RoutineInfo where Day = ? AND Slot = ?";
			PreparedStatement pst = connect.prepareStatement(query);
			pst.setString(1, day+""); pst.setString(2, slot+"");
			ResultSet rs = pst.executeQuery();
			return rs;
		} catch(Exception e){
			return null;
		}
	}
	
	private static ResultSet FindCourses(int day,int slot,int pos){
		try{
			String query = "Select * from RoutineInfo where Day = ? AND Slot = ? AND Pos = ?";
			PreparedStatement pst = connect.prepareStatement(query);
			pst.setString(1, day+""); pst.setString(2, slot+""); pst.setString(3, pos+"");
			ResultSet rs = pst.executeQuery();
			return rs;
		} catch(Exception e){
			return null;
		}
	}
	
	//Two Course on Same slot have same batch
	private static int BatchConflict(int day, int slot, int pos){
		connect = DB.connectdb();
		try{
			//Given day,slot and pos, find the batch number
			String Batch1="",Course1="",Course2="",Batch2="";
			int flag=0;
			//Finding batch of given course
			ResultSet rs1= FindCourses(day,slot,pos);
			while(rs1.next()){
				Course1 = rs1.getString("CourseID");
			}
			String query = "Select Batch from CourseInfo where CourseID = ?";
			PreparedStatement pst = connect.prepareStatement(query);
			pst.setString(1, Course1+"");		;
			
			ResultSet rs= pst.executeQuery();
			while(rs.next()){
				Batch1= rs.getString("Batch");
			}
			//Finding all other course of that slot
			String query2 = "SELECT CourseID from RoutineInfo where Day = ? AND Slot = ? AND Not(Pos) = ?";
			PreparedStatement pst2 = connect.prepareStatement(query2);
			pst2.setString(1, day+""); pst2.setString(2, slot+""); pst2.setString(3, pos+"");
			
			ResultSet rs2= pst2.executeQuery();
			//Matching batch of other courses with given course
			while(rs2.next()){
				Course2= rs2.getString("CourseID");
				String query3 = "Select Batch from CourseInfo where CourseID = '"+Course2+"' ";
				PreparedStatement pst3 = connect.prepareStatement(query3);
				ResultSet rs3 = pst3.executeQuery(); 
				
				while(rs3.next()){
					Batch2= rs3.getString("Batch");
					if(Batch2==null) continue;
					if(Batch2.equals(Batch1)) flag=1;
				}
				pst3.close();
			}
			pst.close();
			pst2.close();
			return flag;
		}catch (Exception e){
			JOptionPane.showMessageDialog(null, e);
			return -1;
		}
	}
	
	//Two Course on Same slot have how many same student
	private static int StudentConflict(int day, int slot, int pos1, int pos2){
		connect = DB.connectdb();
		try{
			String Course1= "",Course2="";
			ResultSet rs1 = FindCourses(day,slot,pos1);
			ResultSet rs2 = FindCourses(day,slot,pos2);
			while(rs1.next()){
				Course1=rs1.getString("CourseID");
			}
			while(rs2.next()){
				Course2=rs2.getString("CourseID");
			}
			if(Course1.equals("") || Course2.equals("")) return 0;
			System.out.println(Course1+ " "+ Course2);
			if(Course1.equals(Course2)) return 0;
			
			//Select all student from Course1
			String query3 = "Select StudentID from StudentInfo where CourseID = ?";
			PreparedStatement pst3 = connect.prepareStatement(query3);
			pst3.setString(1,Course1);
			ResultSet rs3= pst3.executeQuery();
			
			String student1[] = new String[1000];
			int i=0,cou=0,ln=0;
			while(rs3.next()){
				student1[ln++]=rs3.getString("StudentID");
			}
			System.out.println(ln);
			//Select all student from Course2
			String query4 = "Select StudentID from StudentInfo where CourseID = ?";
			PreparedStatement pst4 = connect.prepareStatement(query4);
			pst4.setString(1,Course2);
			ResultSet rs4= pst4.executeQuery();
			/*while(rs4.next()){
				System.out.println(rs4.getString("StudentID"));
			}*/
			
			while(rs3.next()){
			}
			pst3.close();
			pst4.close();
			
			return 1;
		}catch (Exception e){
			JOptionPane.showMessageDialog(null, e);
			return -1;
		}
	}
	
	public static void main(String[] args){
		System.out.println("Hello");
		int n= 0;
		n = BatchConflict(1,1,1);
		n = StudentConflict(1,1,2,1);
		System.out.println(n);
		
		
	}

}
